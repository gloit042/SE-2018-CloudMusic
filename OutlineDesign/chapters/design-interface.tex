\chapter{接口设计}
\section{外部接口}

\subsection{支付接口}

本软件对支付提供了三种手段，分别是微信支付、支付宝支付和Appstore支付。
通过在各支付系统中注册机构账号，然后获取token调用支付API来收费。

\subsection{HTTP接口}
使用HTTP1.0/HTTP1.1/HTTPS协议在前端和后端之间进行交互。API使用了RESTful API，利用JSON进行数据交换。

\noindent JSON所支持的数据类型如下：
\begin{itemize}
	\item \textbf{String}: 字符串
	\item \textbf{Number}: 整数或浮点数
	\item \textbf{Boolean}: 布尔类型
	\item \textbf{Array}: 数组类型
\end{itemize}

数据标记含义如下:
\begin{itemize}
	\item *必填
	\item !只读
	\item ?可选
\end{itemize}

定义扩展数据类型有：
\begin{itemize}
	\item \textbf{DateTime}: ISO-8601字符串，零时区。如 “2017-07-17T07:12:29.181605Z”
	\item \textbf{URL}: 统一资源链接，即字符串
	\item \textbf{Email}: 邮箱名，即字符串
	\item \textbf{Phone}: 电话号码，即字符串
	\item \textbf{User}: 用户信息
	\begin{lstlisting}[numbers=none, frame=none]
{
	id!: Number,
	last_login!: DateTime | null,
	username!: String,
	phone_number: Phone,
	email: Email,
	description: String,
	avatar_url!: URL,
	address: String,
	description: String
}
	\end{lstlisting}
	\item \textbf{Notice}: 通知
	\begin{lstlisting}[numbers=none, frame=none]
{
	id!: Number,
	category!: String,
	message!: String,
	has_read: Boolean,
	created!: DateTime
}
	\end{lstlisting}
	\item \textbf{File}: 文件
	\begin{lstlisting}[numbers=none, frame=none]
{
	id!: Number,
	file: URL,
	mime_type: String
}
	\end{lstlisting}
	\item \textbf{MusicQuality}: 音乐质量，可能有四个值:'128kbps'、'192kbps'、'320kbps'
	\item \textbf{MusicInfo}: 音乐信息
	\begin{lstlisting}[numbers=none, frame=none]
{
	name!: String,
	author!: String,
	upload_time?: DateTime,
	album_name?: String,
	music_id!: String,
}
	\end{lstlisting}
	\item \textbf{SubscriptionInfo}: 订阅信息
	\begin{lstlisting}[numbers=none, frame=none]
{
	name!: String,
	upload_time?: DateTime,
	musics: List<music_id>,
	price: Integer
}
    \end{lstlisting}
	\item \textbf{MusicFileInfo}: 音乐文件信息
	\begin{lstlisting}[numbers=none, frame=none]
{
	quality!: MusicQuality,
	resource_url!: URL
}
	\end{lstlisting}
\end{itemize}


\subsubsection{用户名登录接口}

\noindent
功能：用户使用用户名登录\\
方法：POST\\
URL: /api/users/username\_login/\\
参数:
\begin{lstlisting}[numbers=none, frame=none]
{
    username*: String,
    password*: String,
}
\end{lstlisting}
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 失败： 403 -> String // 失败原因
\end{itemize}

\subsubsection{电话号登录接口}

\noindent
功能：用户使用用户名登录\\
方法：POST\\
URL:/api/users/phone\_login/\\
请求:
\begin{lstlisting}[numbers=none, frame=none]
{
    phone*: Phone,
    password*: String,
}
\end{lstlisting}
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 失败： 403 -> String // 失败原因
\end{itemize}

\subsubsection{登出接口}

\noindent
功能：登出\\
方法：GET\\
URL：/api/users/logout/\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 失败： 403 -> String // 失败原因
\end{itemize}


\subsubsection{用户信息获取接口}

\noindent
功能：获得:id所指示用户的信息\\
方法：GET\\
URL：/api/users/:id/\\
返回:
\begin{itemize}
	\item 成功： 200 -> User
	\item 未登录： 403 -> String = 'not logged'
	\item 不存在： 404
\end{itemize}



\subsubsection{头像上传接口}

\noindent
功能：上传头像\\
方法：POST\\
URL：/api/users/upload\_avatar/\\
请求：
\begin{lstlisting}[numbers=none, frame=none]
{
    file*: File
}
\end{lstlisting}
返回:
\begin{itemize}
	\item 成功： 200 -> String :头像的URL
	\item 未登录： 403 -> String = 'not logged in'
	\item 无文件：400
\end{itemize}


\subsubsection{更改密码接口}

\noindent
功能：更改密码\\
方法：POST\\
URL：/api/users/change\_password/\\
请求：
\begin{lstlisting}[numbers=none, frame=none]
{
    old_pwd*: String,
    new_pwd1*: String,
    new_pwd2*: String
}
\end{lstlisting}
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}

\subsubsection{邮箱重置密码接口}

\noindent
功能：向邮件发送重置链接用于重置密码\\
方法：GET\\
URL：/api/users/reset\_password\_mail/\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 请求过于频繁： 429
	\item 邮件发送失败： 500
\end{itemize}


\subsubsection{手机重置密码接口}

\noindent
功能：向手机发送验证号码用于重置密码\\
方法：GET\\
URL: /api/users/reset\_password\_phone/\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 请求过于频繁： 429
	\item 短信发送失败： 500
\end{itemize}



\subsubsection{获取登录用户信息接口}

\noindent
功能：获得当前登录用户的信息\\
方法：GET\\
URL：/api/users/me/\\
返回:
\begin{itemize}
	\item 成功： 200 -> User
	\item 未登录： 403 -> String = 'not logged in'
\end{itemize}


\subsubsection{搜索音乐接口}

\noindent
功能：对音乐名字进行搜索\\
方法：GET\\
URL：/api/search/music/:name\\
返回:
\begin{itemize}
	\item 成功： 200 -> List<MusicInfo>
	\item 未登录： 403 -> String = 'not logged in'
\end{itemize}

\subsubsection{获取音乐参数接口}

\noindent
功能：获得音乐文件信息\\
方法：GET\\
URL：/api/music/\\
参数: qulity: MusicQuality, music\_id: String\\
返回:
\begin{itemize}
	\item 成功： 200 -> MusicFileInfo
	\item 未付费： 403 -> String = 'Need to purchase'
	\item 未登录： 403 -> String = 'not logged in'
\end{itemize}

\subsubsection{购买音乐接口}

\noindent
功能：购买音乐\\
方法：GET\\
URL：/api/purchase/music/:id\\
参数: method: String, token: String\\
备注：token是由支付方返回的支付凭证
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 付费失败： 403 -> String = 'Fail'
	\item 未登录： 403 -> String = 'not logged in'
\end{itemize}


\subsubsection{搜索订阅接口}

\noindent
功能：对订阅名字进行搜索\\
方法：GET\\
URL：/api/search/subscription/:name\\
返回:
\begin{itemize}
	\item 成功： 200 -> List<SubscriptionInfo>
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}

\subsubsection{购买订阅接口}

\noindent
功能：订阅\\
方法：GET\\
URL：/api/purchase/subscription/:id\\
参数: method: String, token: String\\
备注：token是由支付方返回的支付凭证
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 付费失败： 403 -> String = 'Fail'
	\item 未登录： 403 -> String = 'not logged in'
\end{itemize}

\subsubsection{目标歌曲加入收听列表接口}

\noindent
功能：将目标歌曲加入收听列表\\
方法：GET\\
URL： /api/users/add\_to\_list/\\
参数： music\_id: String, list\_id: String\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}


\subsubsection{从收听列表删除接口}

\noindent
功能：将目标歌曲从收听列表删除\\
方法：GET\\
URL：/api/users/delete\_from\_list/\\
参数： music\_id: String, list\_id: String\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 不存在歌曲： 403 -> String = 'music not found'
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}

\subsubsection{拷贝收听列表接口}

\noindent
功能：拷贝一份收听列表\\
方法：GET\\
URL：/api/users/copylist/\\
参数： list\_id: String\\
返回:
\begin{itemize}
	\item 成功： 200 -> new\_list\_id = String
	\item 不存在列表： 403 -> String = 'list not found'
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}

\subsubsection{删除收听列表接口}

\noindent
功能：删除一份收听列表\\
方法：GET\\
URL：/api/users/deletelist/\\
参数： list\_id: String\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 不存在列表： 403 -> String = 'list not found'
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}

\subsubsection{评论歌曲接口}

\noindent
功能：评论一个歌曲\\
方法：POST\\
URL：/api/music/:id/comment/\\
参数： content: String\\
返回:
\begin{itemize}
	\item 成功： 200 -> String = 'OK'
	\item 不存在歌曲： 403 -> String = 'song not found'
	\item 未登录： 403 -> String = 'not logged'
\end{itemize}


\section{内部接口}
内部模块/系统之间的交互的接口。